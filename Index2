import React, { useState, useMemo } from "react";

/* -------------------------------------------------------------
   VERSION : mise en page propre, compacte, douce en couleur
   - Une seule page pour l'ensemble (Question 2)
   - Grille avec profs en colonnes (Question 3)
   - Style compact mais lisible (Question 4)
   - Couleurs douces (Question 5)
   ------------------------------------------------------------- */

const HOUR_MAP = {
  "1": "8:20-9:10",
  "2": "9:10-10:00",
  "3": "10:20-11:10",
  "4": "11:10-12:00",
  "5": "13:10-14:00",
  "6": "14:00-14:50",
  "7": "15:05-15:55",
  "8": "15:55-16:45",
};

function parseLine(line) {
  const p = line.split(",");
  while (p.length < 7) p.push("");
  const [_, classe, prof, cours, local, jour, heure] = p;

  const f = { classe, prof, cours, local, jour, heure };
  Object.keys(f).forEach(k => { if (!f[k].trim()) f[k] = "/"; });
  return f;
}

export default function App() {
  const [records, setRecords] = useState([]);
  const [selectedProfs, setSelectedProfs] = useState([]);

  function handleFile(e) {
    const file = e.target.files?.[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = ev => {
      const lines = String(ev.target.result)
        .split(/
?
/)
        .map(l => l.trim())
        .filter(Boolean);
      setRecords(lines.map(parseLine));
    };
    reader.readAsText(file);
  }

  const profList = useMemo(() => {
    const s = new Set();
    records.forEach(r => s.add(r.prof));
    return Array.from(s).sort();
  }, [records]);

  function toggleProf(p) {
    if (selectedProfs.includes(p)) setSelectedProfs(selectedProfs.filter(x => x !== p));
    else setSelectedProfs([...selectedProfs, p]);
  }

  // Build grid rows (jours × heures)
  const dayList = useMemo(() => {
    const s = new Set(records.map(r => r.jour));
    return Array.from(s).filter(x => x !== "/").sort();
  }, [records]);

  const hourList = useMemo(() => {
    const s = new Set(records.map(r => r.heure));
    return Array.from(s).filter(x => x !== "/").sort((a, b) => parseInt(a) - parseInt(b));
  }, [records]);

  function cellContent(j, h, prof) {
    const item = records.find(r => r.prof === prof && r.jour === j && r.heure === h);
    if (!item) return "";
    return `${item.classe} - ${item.cours} (${item.local})`;
  }

  return (
    <div style={{ fontFamily: 'Arial', padding: '20px', maxWidth: '1100px', margin: '0 auto', lineHeight: '1.2' }}>
      <h1 style={{ fontSize: '20px', fontWeight: 'bold', marginBottom: '15px' }}>Grille globale des professeurs</h1>

      <input type="file" accept="text/*" onChange={handleFile} />

      <h2 style={{ marginTop: '20px', fontSize: '16px' }}>Sélection des professeurs</h2>
      <div style={{ marginTop: '10px' }}>
        {profList.map(p => (
          <button
            key={p}
            onClick={() => toggleProf(p)}
            style={{
              padding: '4px 6px',
              margin: '3px',
              fontSize: '12px',
              border: '1px solid #888',
              background: selectedProfs.includes(p) ? '#dfeaff' : '#ffffff',
              cursor: 'pointer'
            }}
          >
            {p}
          </button>
        ))}
      </div>

      {selectedProfs.length > 0 && (
        <div style={{ marginTop: '30px', overflowX: 'auto' }}>
          <table style={{ width: '100%', borderCollapse: 'collapse', fontSize: '12px' }}>
            <thead>
              <tr>
                <th style={th}>Jour</th>
                <th style={th}>Heure</th>
                {selectedProfs.map(p => (
                  <th key={p} style={{ ...th, background: '#e8f0ff' }}>{p}</th>
                ))}
              </tr>
            </thead>

            <tbody>
              {dayList.flatMap(jour => (
                hourList.map(heure => (
                  <tr key={jour + heure}>
                    <td style={td}>{jour}</td>
                    <td style={td}>{heure} ({HOUR_MAP[heure]})</td>
                    {selectedProfs.map(p => (
                      <td key={p} style={{ ...td, background: '#f8fbff' }}>
                        {cellContent(jour, heure, p)}
                      </td>
                    ))}
                  </tr>
                ))
              ))}
            </tbody>
          </table>
        </div>
      )}
    </div>
  );
}

const th = {
  border: '1px solid #bbb',
  padding: '6px 4px',
  background: '#f3f3f3',
  fontWeight: 'bold',
  textAlign: 'center'
};

const td = {
  border: '1px solid #ccc',
  padding: '4px 3px',
  verticalAlign: 'top'
};
